<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="referrer" content="no-referrer"/>
  <title>LAYOUTPLACE Shop</title>

  <link rel="stylesheet" href="/web/style.css?v=7"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="/web/app.js?v=7" defer></script>
</head>
<body>

  <!-- ===== –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ ===== -->
  <div id="imgViewer" class="hidden">
    <!-- ‚úÖ –∫—Ä–µ—Å—Ç–∏–∫ -->
    <button id="viewerClose" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>

    <img src="" alt="preview"/>
    <div id="viewerDots"></div>
  </div>

  <header class="topbar">
    <div>
      <div id="shopTitle" class="shop-title"></div>
      <div id="subtitle" class="subtitle"></div>
    </div>
    <button id="cartBtn" class="cart-btn" aria-label="–ö–æ—Ä–∑–∏–Ω–∞">
      üõí <span id="cartCount">0</span>
    </button>
  </header>

  <main class="container">
    <div id="hero" class="hero hidden"></div>
    <div id="categories" class="cat-grid"></div>
    <div id="products" class="products"></div>
  </main>

  <footer class="bottom">
    <button id="writeBtn" class="btn ghost">–ù–∞–ø–∏—Å–∞—Ç—å</button>
    <button id="checkoutBtn" class="btn primary">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
  </footer>

  <div id="sheet" class="sheet hidden"></div>
  <div id="backdrop" class="backdrop hidden"></div>

  <!-- ‚úÖ Viewer script: try/catch + —Ñ–∏–∫—Å iOS "–¥–≤–æ–π–Ω–æ–≥–æ —à–∞–≥–∞" (touchend + click) + –∫—Ä–µ—Å—Ç–∏–∫ -->
  <script>
  (function () {
    try {
      const viewer = document.getElementById("imgViewer");
      const viewerImg = viewer ? viewer.querySelector("img") : null;
      const viewerDots = document.getElementById("viewerDots");
      const viewerClose = document.getElementById("viewerClose");

      if (!viewer || !viewerImg) return;

      let album = [];
      let idx = 0;

      let startX = 0, startY = 0;
      let scale = 1, startDist = 0;
      let moved = false;

      // ‚úÖ –∞–Ω—Ç–∏-–¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫: iOS –ø–æ—Å–ª–µ touch —á–∞—Å—Ç–æ —Å—Ç—Ä–µ–ª—è–µ—Ç click
      let lastTouchAt = 0;

      function renderDots() {
        if (!viewerDots) return;
        if (!album.length || album.length <= 1) {
          viewerDots.innerHTML = "";
          return;
        }
        viewerDots.innerHTML = album
          .map((_, i) => `<span class="viewer-dot ${i === idx ? "active" : ""}"></span>`)
          .join("");
      }

      function setImage(i) {
        if (!album.length) return;
        idx = (i + album.length) % album.length;
        viewerImg.src = album[idx];
        scale = 1;
        viewerImg.style.transform = "scale(1)";
        renderDots();
      }

      function openViewerFromAlbum(list, startIndex = 0) {
        album = (list || []).map(s => (s || "").trim()).filter(Boolean);
        if (!album.length) return;

        viewer.classList.remove("hidden");
        document.body.style.overflow = "hidden";
        setImage(startIndex);
      }

      function closeViewer() {
        viewer.classList.add("hidden");
        viewerImg.src = "";
        document.body.style.overflow = "";

        album = [];
        idx = 0;
        scale = 1;
        startDist = 0;
        viewerImg.style.transform = "scale(1)";
        if (viewerDots) viewerDots.innerHTML = "";
      }

      function next() { setImage(idx + 1); }
      function prev() { setImage(idx - 1); }

      function tapNav(clientX) {
        if (!album.length) return;
        if (scale > 1.01) return;

        const w = window.innerWidth || document.documentElement.clientWidth || 1;
        if (clientX < w * 0.33) prev();
        else if (clientX > w * 0.66) next();
        else closeViewer();
      }

      // ‚úÖ –∫—Ä–µ—Å—Ç–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è
      if (viewerClose) {
        viewerClose.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeViewer();
        }, true);
        // –Ω–∞ iOS –ø–æ—Å–ª–µ touch –º–æ–∂–µ—Ç –±—ã—Ç—å click ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º
        viewerClose.addEventListener("touchend", (e) => {
          lastTouchAt = Date.now();
          e.preventDefault();
          e.stopPropagation();
          closeViewer();
        }, { passive: false });
      }

      // ‚úÖ –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ —Ç–∞–ø—É –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ/hero
      document.addEventListener("click", (e) => {
        // ‚úÖ –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ —á—Ç–æ –±—ã–ª touch ‚Äî –∏–≥–Ω–æ—Ä–∏–º click
        if (Date.now() - lastTouchAt < 450) return;

        if (!viewer.classList.contains("hidden")) return;

        const img = e.target.closest(".thumb img, .hero-img img, .gallery-slide img");
        if (!img) return;

        const albumRaw = img.getAttribute("data-album") || "";
        const list = albumRaw
          ? albumRaw.split("|").map(s => s.trim()).filter(Boolean)
          : [img.getAttribute("src")].filter(Boolean);

        if (!list.length) return;

        e.preventDefault();
        e.stopPropagation();
        openViewerFromAlbum(list, 0);
      }, true);

      // ‚úÖ –ó–∞–∫—Ä—ã—Ç—å –ø–æ —Ñ–æ–Ω—É
      viewer.addEventListener("click", (e) => {
        if (Date.now() - lastTouchAt < 450) return;
        if (e.target === viewer) closeViewer();
      }, true);

      // ‚úÖ –¢–∞–ø –ø–æ —Ñ–æ—Ç–æ ‚Üí –ª–∏—Å—Ç–∞—Ç—å/–∑–∞–∫—Ä—ã—Ç—å
      viewerImg.addEventListener("click", (e) => {
        if (Date.now() - lastTouchAt < 450) return;
        if (moved) return;
        tapNav(e.clientX);
      }, true);

      // Touch start
      viewer.addEventListener("touchstart", (e) => {
        moved = false;

        if (e.touches.length === 1) {
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
        }
        if (e.touches.length === 2) {
          const dx = e.touches[1].clientX - e.touches[0].clientX;
          const dy = e.touches[1].clientY - e.touches[0].clientY;
          startDist = Math.sqrt(dx*dx + dy*dy);
        }
      }, { passive: true });

      // Touch move (zoom)
      viewer.addEventListener("touchmove", (e) => {
        moved = true;

        if (e.touches.length === 2 && startDist) {
          const dx = e.touches[1].clientX - e.touches[0].clientX;
          const dy = e.touches[1].clientY - e.touches[0].clientY;
          const newDist = Math.sqrt(dx*dx + dy*dy);

          scale *= newDist / startDist;
          startDist = newDist;
          scale = Math.max(1, Math.min(scale, 4));
          viewerImg.style.transform = `scale(${scale})`;
        }
      }, { passive: true });

      // Touch end (swipe/tap)
      viewer.addEventListener("touchend", (e) => {
        lastTouchAt = Date.now(); // ‚úÖ –±–ª–æ–∫–∏—Ä—É–µ–º —Å–ª–µ–¥–æ–º –∏–¥—É—â–∏–π click

        if (!album.length) return;
        startDist = 0;

        const t = e.changedTouches && e.changedTouches[0];
        if (!t) return;

        const endX = t.clientX;
        const endY = t.clientY;

        const dx = endX - startX;
        const dy = endY - startY;

        if (Math.abs(dx) > 60 && Math.abs(dx) > Math.abs(dy)) {
          if (dx < 0) next();
          else prev();
        } else {
          if (Math.abs(dx) < 12 && Math.abs(dy) < 12) tapNav(endX);
          if (dy > 140) closeViewer();
        }

        startX = 0; startY = 0;
        setTimeout(() => { moved = false; }, 0);
      }, { passive: true });

      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && !viewer.classList.contains("hidden")) closeViewer();
        if (e.key === "ArrowRight" && album.length) next();
        if (e.key === "ArrowLeft"  && album.length) prev();
      });
    } catch (err) {
      console.error("Viewer init error:", err);
    }
  })();
  </script>

</body>
</html>
